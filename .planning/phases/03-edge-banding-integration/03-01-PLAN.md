---
phase: 03-edge-banding-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/utils/cabinetLogic.ts]
autonomous: true
---

<objective>
Integrate edge banding thickness into part dimension calculations so cut list shows accurate cutting dimensions.

Purpose: When edge banding is applied to a part, the cut dimension must be reduced by the banding thickness so the final banded dimension matches the design intent. Currently dimensions don't account for banding thickness.
Output: calculateParts() returns dimensions adjusted for edge banding, with detailed edge banding material info in each CutPart.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Prior phase context (Phase 2 established material resolution patterns)
@.planning/phases/02-part-material-association/02-01-SUMMARY.md

# Source files
@src/utils/cabinetLogic.ts
@src/types/index.ts
@src/data/defaultMaterials.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add edge banding thickness resolution helper</name>
  <files>src/utils/cabinetLogic.ts</files>
  <action>
Create a `getEdgeBandingThickness()` helper function that resolves edge banding thickness:

```typescript
export function getEdgeBandingThickness(
  edgeBandingId: string | undefined,
  materials: Material[],
  fallbackThickness: number = 0
): number
```

Resolution logic:
1. If `edgeBandingId` provided, find material and return its `thickness`
2. If not found, return `fallbackThickness`

This follows the same pattern as `getMaterialThickness()` from Phase 2.

Place this function in the "Material Thickness Resolution" section, after `getMaterialThickness()`.
  </action>
  <verify>TypeScript compiles: `cd /home/faky/Dev/work/Ligna && npm run build`</verify>
  <done>Function exists and exports correctly, follows Phase 2 pattern</done>
</task>

<task type="auto">
  <name>Task 2: Calculate edge banding adjustments in calculateParts</name>
  <files>src/utils/cabinetLogic.ts</files>
  <action>
Modify `calculateParts()` to adjust dimensions for edge banding:

1. Accept optional `edgeBandingId` parameter (the default edge banding material to use)
2. For each part rule with `edgeBanding` defined:
   - Resolve the edge banding material ID: use pattern's `materials.edgeBanding.materialId` or fall back to `edgeBandingId` parameter
   - Get edge banding thickness via `getEdgeBandingThickness()`
   - Subtract edge banding thickness from `length` for each length edge with banding (`L1`, `L2`)
   - Subtract edge banding thickness from `width` for each width edge with banding (`W1`, `W2`)

Adjustment formula:
- `finalLength = calculatedLength - (L1_banding ? ebThickness : 0) - (L2_banding ? ebThickness : 0)`
- `finalWidth = calculatedWidth - (W1_banding ? ebThickness : 0) - (W2_banding ? ebThickness : 0)`

This ensures the cut dimension plus banding equals the design dimension.

Note: Do NOT modify the expression evaluation - adjustments happen AFTER evaluateExpression() returns the design dimension.
  </action>
  <verify>TypeScript compiles: `cd /home/faky/Dev/work/Ligna && npm run build`</verify>
  <done>Part dimensions correctly adjusted for edge banding on all applicable edges</done>
</task>

<task type="auto">
  <name>Task 3: Populate edge banding details in CutPart</name>
  <files>src/utils/cabinetLogic.ts</files>
  <action>
Enhance the CutPart output to include detailed edge banding information:

1. For each part with edge banding:
   - Populate `edgeBandingDetails` object with the material ID used for each edge
   - Set `edgeBandingDetails.length1` to the material ID if L1 has banding
   - Set `edgeBandingDetails.length2` to the material ID if L2 has banding
   - Set `edgeBandingDetails.width1` to the material ID if W1 has banding
   - Set `edgeBandingDetails.width2` to the material ID if W2 has banding

2. Keep the existing `edgeBanding` string field (e.g., "L1, L2") for backward compatibility

The `edgeBandingDetails` allows downstream code to look up exact materials and thicknesses for each edge.
  </action>
  <verify>TypeScript compiles: `cd /home/faky/Dev/work/Ligna && npm run build`</verify>
  <done>CutPart includes both edge string and detailed material info per edge</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npm run build` succeeds without errors
- [ ] `getEdgeBandingThickness()` function exists and is exported
- [ ] `calculateParts()` accepts edge banding parameters
- [ ] Part dimensions are reduced by edge banding thickness on banded edges
- [ ] `CutPart.edgeBandingDetails` populated with material IDs
</verification>

<success_criteria>

- All tasks completed
- All verification checks pass
- No TypeScript errors
- Edge banding thickness correctly subtracted from cut dimensions
- Edge banding material details available in CutPart output
</success_criteria>

<output>
After completion, create `.planning/phases/03-edge-banding-integration/03-01-SUMMARY.md`
</output>
